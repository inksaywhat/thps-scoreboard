<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THPS All Time Record</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to match the wireframe's aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
        }
        .player-card {
            background-color: #1F2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
        }
        .btn-mitch {
            background-color: #3B82F6; /* blue-500 */
            transition: background-color 0.3s;
        }
        .btn-mitch:hover {
            background-color: #2563EB; /* blue-600 */
        }
        .btn-patrick {
            background-color: #10B981; /* green-500 */
            transition: background-color 0.3s;
        }
        .btn-patrick:hover {
            background-color: #059669; /* green-600 */
        }
        .history-table {
            background-color: #1F2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
        }
        .modal-content {
             background-color: #1F2937; /* gray-800 */
        }
    </style>
</head>
<body class="text-white">

    <div class="container mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-black tracking-wider uppercase" style="color: #FBBF24;">THPS All Time Record</h1>
            <p class="text-lg md:text-xl text-gray-400 font-bold tracking-widest mt-1">MITCH VS PATRICK</p>
        </header>

        <!-- Player Score Cards -->
        <main class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 mb-8">
            <!-- Mitch's Card -->
            <div class="player-card rounded-lg p-6 text-center shadow-lg">
                <h2 class="text-3xl font-bold text-blue-400">MITCH</h2>
                <div id="mitch-score" class="text-8xl font-black my-4">0</div>
                <p id="mitch-tally" class="text-gray-400 h-6">No wins yet!</p>
                <button id="add-win-mitch" class="w-full mt-4 py-3 rounded-lg text-lg font-bold btn-mitch">Add Win for Mitch</button>
            </div>

            <!-- Patrick's Card -->
            <div class="player-card rounded-lg p-6 text-center shadow-lg">
                <h2 class="text-3xl font-bold text-green-400">PATRICK</h2>
                <div id="patrick-score" class="text-8xl font-black my-4">0</div>
                <p id="patrick-tally" class="text-gray-400 h-6">No wins yet!</p>
                <button id="add-win-patrick" class="w-full mt-4 py-3 rounded-lg text-lg font-bold btn-patrick">Add Win for Patrick</button>
            </div>
        </main>

        <!-- Game History -->
        <section class="history-table rounded-lg p-6 shadow-lg">
            <h3 class="text-2xl font-bold text-center mb-4">Game History</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="border-b-2 border-gray-600">
                        <tr>
                            <th class="p-2">WINNER</th>
                            <th class="p-2">DATE</th>
                            <th class="p-2 text-right">TIME</th>
                        </tr>
                    </thead>
                    <tbody id="history-body">
                        <!-- History rows will be injected here by JavaScript -->
                         <tr><td colspan="3" class="text-center p-4 text-gray-500">No games recorded yet. Let the battle begin!</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden">
        <div class="modal-content rounded-lg p-8 shadow-2xl text-center max-w-sm w-full border border-gray-600">
            <p id="modal-message" class="text-lg mb-6">Are you sure?</p>
            <div class="flex justify-center gap-4">
                <button id="modal-btn-yes" class="px-8 py-2 rounded-lg bg-green-600 hover:bg-green-700 font-bold transition">Yes</button>
                <button id="modal-btn-no" class="px-8 py-2 rounded-lg bg-red-600 hover:bg-red-700 font-bold transition">No</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase Core Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, onSnapshot, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // IMPORTANT: This event listener ensures the entire page is loaded before the script runs.
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'thps-scoreboard-app';
            
            // --- FIREBASE INITIALIZATION ---
            let app, auth, db;
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                // Do not use alert() here as it can block the script.
                document.body.innerHTML = '<div class="text-white text-center p-8">Could not connect to the database. Please check the configuration.</div>';
                return;
            }

            // --- DOM ELEMENTS ---
            const mitchScoreEl = document.getElementById('mitch-score');
            const patrickScoreEl = document.getElementById('patrick-score');
            const mitchTallyEl = document.getElementById('mitch-tally');
            const patrickTallyEl = document.getElementById('patrick-tally');
            const addWinMitchBtn = document.getElementById('add-win-mitch');
            const addWinPatrickBtn = document.getElementById('add-win-patrick');
            const historyBody = document.getElementById('history-body');
            const modal = document.getElementById('confirmation-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalBtnYes = document.getElementById('modal-btn-yes');
            const modalBtnNo = document.getElementById('modal-btn-no');

            // --- SHIT-TALKING MESSAGES ---
            const taunts = [
                "that win was charity dont get cocky", "congrats ur now slightly less trash", "your opponent was texting their ex when u won that calm down", "wow ur mom must be so proud of u winning once", "click yes to admit that was pure luck", "so u finally figured out how to play huh genius", "even a blind squirrel finds a win sometimes", "say yes if ur the flukiest fluke to ever fluke", "that win was mid and u know it", "this win brought to u by sheer opponent mercy", "click yes to inflate ur ego even more u princess", "damn ur on fire psych just one win relax", "even my grandma coulda blocked that", "was that u winning or did your opponent sneeze", "congrats on ur first win since 2019", "yes u won no ur still not good", "if u click yes ur officially proud of mediocrity", "more like pathetic lmao click yes loser", "that was less a win more an opponent error", "someone screenshot this rare ass moment", "1 win closer to being slightly less irrelevant", "click yes if u peaked just now", "ur gameplay is as soft as ur handshake", "u lil bitch stop smiling and click yes", "that win was so weak i almost sneezed it away", "u celebrating this like u won the olympics chill", "click yes to admit your opponent went easy on ur ass", "was that skill or divine intervention", "this win aged like milk", "click yes if u just got lucky af", "wow u won finally took u 30 tries", "that win had less power than ur wifi signal", "nice job winning on a distracted manchild", "ur basically the participation trophy of this game", "click yes if ur the weakest alpha ever", "that wasn’t talent bro that was pity in motion", "u win one game and suddenly think ur lebron", "click yes if ur the real life underdog story no one asked for", "your opponent literally blinked and u won relax", "ur form was trash but hey a win's a win", "out here grinding for the most average victory", "click yes to confirm ur fluke streak continues", "ur gameplay is so vanilla it hurts", "congrats u beat a guy running on 2 hours of sleep", "u play like someone’s dad trying his best", "click yes if u bribed the scoreboard app", "that win felt like watching paint dry but go off king", "that win was as accidental as ur birth"
            ];
            
            let playerToCredit = null;

            // --- AUTHENTICATION ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("User authenticated:", user.uid);
                    // User is signed in, start listening for real-time updates.
                    listenForUpdates();
                } else {
                    console.log("No user signed in, determining auth method...");
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        console.log("Attempting sign-in with custom token...");
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } catch (error) {
                            console.error("Custom token sign-in failed:", error);
                            console.log("Falling back to anonymous sign-in.");
                            try {
                                await signInAnonymously(auth);
                            } catch (anonError) {
                                console.error("Anonymous sign-in also failed:", anonError);
                                // Display error to user without alert
                                document.body.innerHTML = '<div class="text-white text-center p-8">Could not establish a secure connection.</div>';
                            }
                        }
                    } else {
                        console.log("Attempting anonymous sign-in...");
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Anonymous sign-in failed:", error);
                             // Display error to user without alert
                            document.body.innerHTML = '<div class="text-white text-center p-8">Could not establish a secure connection.</div>';
                        }
                    }
                }
            });

            // --- REAL-TIME DATA LISTENER ---
            function listenForUpdates() {
                const gamesCollectionPath = `artifacts/${appId}/public/data/games`;
                const q = query(collection(db, gamesCollectionPath));

                onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        console.log("No games found in the database.");
                        resetUI();
                        return;
                    }

                    const games = [];
                    snapshot.forEach(doc => {
                        games.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Sort games by timestamp, newest first.
                    games.sort((a, b) => {
                        const timeA = a.timestamp?.toMillis() || 0;
                        const timeB = b.timestamp?.toMillis() || 0;
                        return timeB - timeA;
                    });
                    
                    updateUI(games);

                }, (error) => {
                    console.error("Error listening to database:", error);
                    // Display error to user without alert
                     document.body.innerHTML = '<div class="text-white text-center p-8">Lost connection to the scoreboard. Please refresh the page.</div>';
                });
            }

            // --- UI UPDATE LOGIC ---
            function updateUI(games) {
                let mitchWins = 0;
                let patrickWins = 0;

                // Calculate scores
                games.forEach(game => {
                    if (game.winner === 'Mitch') {
                        mitchWins++;
                    } else if (game.winner === 'Patrick') {
                        patrickWins++;
                    }
                });

                // Update score displays
                mitchScoreEl.textContent = mitchWins;
                patrickScoreEl.textContent = patrickWins;
                
                // Update tally marks
                mitchTallyEl.textContent = mitchWins > 0 ? 'I'.repeat(mitchWins) : 'No wins yet!';
                patrickTallyEl.textContent = patrickWins > 0 ? 'I'.repeat(patrickWins) : 'No wins yet!';

                // Update history table
                historyBody.innerHTML = ''; // Clear previous entries
                if(games.length > 0) {
                    games.forEach(game => {
                        const date = game.timestamp ? game.timestamp.toDate() : new Date();
                        const winnerClass = game.winner === 'Mitch' ? 'text-blue-400' : 'text-green-400';
                        const row = `
                            <tr class="border-b border-gray-700">
                                <td class="p-2 font-bold ${winnerClass}">${game.winner.toUpperCase()}</td>
                                <td class="p-2 text-gray-400">${date.toLocaleDateString()}</td>
                                <td class="p-2 text-gray-400 text-right">${date.toLocaleTimeString()}</td>
                            </tr>
                        `;
                        historyBody.innerHTML += row;
                    });
                } else {
                     historyBody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-500">No games recorded yet. Let the battle begin!</td></tr>';
                }
            }
            
            function resetUI() {
                mitchScoreEl.textContent = '0';
                patrickScoreEl.textContent = '0';
                mitchTallyEl.textContent = 'No wins yet!';
                patrickTallyEl.textContent = 'No wins yet!';
                historyBody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-500">No games recorded yet. Let the battle begin!</td></tr>';
            }

            // --- MODAL AND EVENT HANDLING ---
            function openConfirmationModal(player) {
                playerToCredit = player;
                const randomTaunt = taunts[Math.floor(Math.random() * taunts.length)];
                modalMessage.textContent = randomTaunt;
                modal.classList.remove('hidden');
            }

            function closeConfirmationModal() {
                playerToCredit = null;
                modal.classList.add('hidden');
            }
            
            async function addWin() {
                if (!playerToCredit) return;

                const gamesCollectionPath = `artifacts/${appId}/public/data/games`;
                try {
                    await addDoc(collection(db, gamesCollectionPath), {
                        winner: playerToCredit,
                        timestamp: serverTimestamp()
                    });
                    console.log(`Win logged for ${playerToCredit}`);
                } catch (error) {
                    console.error("Error adding document: ", error);
                    modalMessage.textContent = 'Failed to record win. Please try again.';
                    modal.classList.remove('hidden');
                    setTimeout(() => modal.classList.add('hidden'), 3000);
                }
            }

            // Event Listeners
            addWinMitchBtn.addEventListener('click', () => openConfirmationModal('Mitch'));
            addWinPatrickBtn.addEventListener('click', () => openConfirmationModal('Patrick'));
            
            modalBtnNo.addEventListener('click', closeConfirmationModal);
            
            modalBtnYes.addEventListener('click', () => {
                addWin();
                closeConfirmationModal();
            });

            // Close modal if clicking outside of it
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeConfirmationModal();
                }
            });
        });
    </script>
</body>
</html>
